<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/favicon.ico" type="image/x-icon" />
  <title>Alt Text Rating</title>
  <script src="https://kit.fontawesome.com/830b363cf0.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    #results {
      display: none;
    }
    /* Force the gauge canvas to be square and centered */
    #gaugeChart {
      display: block;
      margin: 20px auto;
      width: 366px !important;
      height: 366px !important;
    }
  </style>
  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Navigation -->
  <div id="nav"></div>

  <!-- Main Content -->
  <main>
    <div id="alt-text-rating-form" class="alt-card">
      <h1>Bluesky Alt Text Rating</h1>
      <form class="search-bar" id="search-form">
        <input type="text" id="username" placeholder="(e.g., dame.bsky.social)" required />
        <button type="submit">Analyze</button>
      </form>
      <!-- Results container -->
      <div class="results" id="results">
        <p id="textResults"></p>
        <!-- Canvas element for the gauge -->
        <canvas id="gaugeChart"></canvas>
        <p>
          <a href="https://bsky.app/profile/cred.blue" target="_blank">
            Discover more tools: @cred.blue
          </a>
        </p>
      </div>
    </div>
    <!-- Extra info card (always visible) -->
    <div id="extra-info" class="alt-card">
      <div class="resources">
        <h3>Learn more about alt text:</h3>
        <ul>
          <li>
            <a href="https://bsky.app/settings/accessibility" target="_blank">
              Change your Bluesky alt text settings
            </a>
          </li>
          <li>
            <a href="https://www.section508.gov/create/alternative-text/" target="_blank">
              Authoring Meaningful Alternative Text
            </a>
          </li>
          <li>
            <a href="https://accessibility.huit.harvard.edu/describe-content-images" target="_blank">
              Write helpful Alt Text to describe images
            </a>
          </li>
        </ul>
      </div>
    </div>
    
    <script>
      // ----------------------------
      // Analysis Functions (unchanged)
      // ----------------------------
      const PUBLIC_API_URL = "https://public.api.bsky.app";
      const emojis = ["‚òπÔ∏è", "üòê", "üôÇ", "‚ò∫Ô∏è"];
      const MIN_DATE = new Date("2022-11-16T00:00:00Z");

      async function resolveHandleToDID(handle) {
        try {
          const res = await fetch(`${PUBLIC_API_URL}/xrpc/com.atproto.identity.resolveHandle?handle=${encodeURIComponent(handle)}`);
          const data = await res.json();
          if (data.did) return data.did;
          throw new Error(`Unable to resolve DID for handle: ${handle}`);
        } catch (error) {
          console.error("Error resolving handle to DID:", error);
          throw error;
        }
      }

      async function fetchServiceEndpoint(did) {
        try {
          const res = await fetch(`https://plc.directory/${did}`);
          const data = await res.json();
          if (data.service && data.service.length > 0) {
            const serviceEndpoint = data.service[0].serviceEndpoint;
            if (serviceEndpoint) return serviceEndpoint;
          }
          throw new Error(`Service endpoint not found for DID: ${did}`);
        } catch (error) {
          console.error("Error fetching service endpoint:", error);
          throw error;
        }
      }

      async function fetchRecordsForCollection(serviceEndpoint, did, collectionName) {
        let urlBase = `${serviceEndpoint}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(did)}&collection=${encodeURIComponent(collectionName)}&limit=100`;
        let records = [];
        let cursor = null;
        do {
          const url = cursor ? `${urlBase}&cursor=${cursor}` : urlBase;
          const res = await fetch(url);
          const data = await res.json();
          if (Array.isArray(data.records)) {
            records = records.concat(data.records);
          }
          cursor = data.cursor || null;
        } while (cursor);
        return records;
      }

      function analyzePosts(records) {
        const filteredRecords = records.filter(rec => {
          if (rec.value.createdAt) {
            const postDate = new Date(rec.value.createdAt);
            return postDate >= MIN_DATE;
          }
          return false;
        });
        const postsWithImages = filteredRecords.filter(rec =>
          rec.value.embed && rec.value.embed["$type"] === "app.bsky.embed.images"
        );
        const postsWithAltText = postsWithImages.filter(rec =>
          rec.value.embed.images.some(img => img.alt && img.alt.trim())
        );
        const imageReplies = filteredRecords.filter(rec =>
          rec.value.embed &&
          rec.value.embed["$type"] === "app.bsky.embed.images" &&
          rec.value.reply
        );

        const altTextPercentage = (postsWithAltText.length / postsWithImages.length) * 100 || 0;
        let emoji = emojis[0];
        if (altTextPercentage >= 75) {
          emoji = emojis[3];
        } else if (altTextPercentage >= 50) {
          emoji = emojis[2];
        } else if (altTextPercentage >= 25) {
          emoji = emojis[1];
        }
        return {
          totalPosts: filteredRecords.length,
          postsWithImages: postsWithImages.length,
          postsWithAltText: postsWithAltText.length,
          imageReplies: imageReplies.length,
          altTextPercentage: altTextPercentage,
          emoji: emoji,
        };
      }

      // ----------------------------
      // Chart.js Gauge (with four quadrants)
      // ----------------------------
      function renderGauge(score) {
        // Get the canvas context
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        // Destroy any existing chart instance if present
        if (window.gaugeChartInstance) {
          window.gaugeChartInstance.destroy();
        }
        // Define four quadrants, each representing 25%
        const gaugeData = [25, 25, 25, 25];
        // Colors for the quadrants (modify as desired)
        const quadrantColors = ['#ff0000', '#ff9900', '#ffff66', '#00cc00'];

        window.gaugeChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: gaugeData,
              backgroundColor: quadrantColors,
              borderWidth: 0,
            }]
          },
          options: {
            responsive: false,
            maintainAspectRatio: false,
            rotation: Math.PI,        // Start at 180¬∞ (left)
            circumference: Math.PI,     // Draw half a circle (180¬∞ span)
            cutout: '60%',              // Thickness of the doughnut
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false }
            },
            layout: {
              padding: {
                bottom: 20 // extra padding if needed
              }
            },
            animation: {
              animateRotate: true,
              animateScale: true
            },
            // Custom plugin to draw the needle
            plugins: [{
              id: 'needle',
              afterDraw: function(chart, easing) {
                const ctx = chart.ctx;
                const cw = chart.width;
                const ch = chart.height;
                // Map score (0-100) to an angle between Math.PI (left) and 0 (right)
                const angle = Math.PI - (score / 100) * Math.PI;
                // For a half-doughnut drawn with rotation: Math.PI, the arc's center
                // is at (cw/2, ch/2). We'll use that as the needle's pivot.
                const cx = cw / 2;
                const cy = ch / 2;
                // Use the smaller of half the canvas width or height as reference for length
                const r = Math.min(cx, cy);
                const needleLength = r * 0.9;
                // Calculate the needle endpoint
                const x = cx + needleLength * Math.cos(angle);
                const y = cy + needleLength * Math.sin(angle);
                ctx.save();
                // Draw the needle line
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.lineWidth = 4;
                ctx.strokeStyle = "#000";
                ctx.stroke();
                // Draw the needle pivot as a circle
                ctx.beginPath();
                ctx.arc(cx, cy, 5, 0, Math.PI * 2);
                ctx.fillStyle = "#000";
                ctx.fill();
                ctx.restore();
              }
            }]
          }
        });
      }

      // ----------------------------
      // Form Handler
      // ----------------------------
      document.getElementById("search-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const username = document.getElementById("username").value.trim();
        const resultsDiv = document.getElementById("results");
        const textResults = document.getElementById("textResults");
        resultsDiv.style.display = "block";
        textResults.textContent = "Loading...";

        try {
          const did = await resolveHandleToDID(username);
          const serviceEndpoint = await fetchServiceEndpoint(did);
          const records = await fetchRecordsForCollection(serviceEndpoint, did, "app.bsky.feed.post");
          const analysis = analyzePosts(records);
          const scoreText = analysis.postsWithImages === 0
            ? "No image posts detected! üîç"
            : `${analysis.altTextPercentage.toFixed(2)}% ${analysis.emoji}`;
          
          // Update text results with analysis details
          textResults.innerHTML = `
            <p>${analysis.totalPosts} posts analyzed</p>
            <p>${analysis.postsWithImages} contain images</p>
            <p>${analysis.imageReplies} are replies</p>
            <p>${analysis.postsWithAltText} posts have alt text</p>
            <h2>Score: ${scoreText}</h2>
            <div id="chart"></div>
            <a href="https://bsky.app/profile/cred.blue" target="_blank">Discover more tools: @cred.blue</a>
          `;
          // Render the gauge based on the alt text percentage (score)
          renderGauge(analysis.altTextPercentage);
        } catch (error) {
          resultsDiv.textContent = `Error: ${error.message}`;
        }
      });
    </script>
  </main>

  <!-- Footer -->
  <div id="footer"></div>
  <script src="js/main.js"></script>
</body>
</html>
