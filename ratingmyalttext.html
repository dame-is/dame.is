<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="images/favicon.ico" type="image/x-icon">
<title>alt text rating</title>
<script src="https://kit.fontawesome.com/830b363cf0.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .search-bar {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }
    .search-bar input {
      width: 300px;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px 0 0 5px;
    }
    .search-bar button {
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
    }
    .search-bar button:hover {
      background-color: #0056b3;
    }
    .results {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
    <!-- Navigation -->
    <div id="nav"></div>

    <!-- Main Content -->
    <main>
        <div id="alt-text-rating-form">
            <h1>Bluesky Alt Text Rating</h1>
            <form class="search-bar" id="search-form">
              <input type="text" id="username" placeholder="Enter Bluesky username (e.g., dame.bsky.social)" required />
              <button type="submit">Search</button>
            </form>
            <div class="results" id="results"></div>
          
            <script>
              const PUBLIC_API_URL = "https://public.api.bsky.app";
          
              async function resolveHandleToDID(handle) {
                try {
                  const res = await fetch(`${PUBLIC_API_URL}/xrpc/com.atproto.identity.resolveHandle?handle=${encodeURIComponent(handle)}`);
                  const data = await res.json();
                  if (data.did) {
                    return data.did;
                  } else {
                    throw new Error(`Unable to resolve DID for handle: ${handle}`);
                  }
                } catch (error) {
                  console.error('Error resolving handle to DID:', error);
                  throw error;
                }
              }
          
              async function fetchRecordsForCollection(did, collectionName) {
                let urlBase = `${PUBLIC_API_URL}/xrpc/com.atproto.repo.listRecords?repo=${encodeURIComponent(did)}&collection=${encodeURIComponent(collectionName)}&limit=100`;
                let records = [];
                let cursor = null;
          
                do {
                  const url = cursor ? `${urlBase}&cursor=${cursor}` : urlBase;
                  const res = await fetch(url);
                  const data = await res.json();
          
                  if (Array.isArray(data.records)) {
                    records = records.concat(data.records);
                  }
                  cursor = data.cursor || null;
                } while (cursor);
          
                return records;
              }
          
              function analyzePosts(records) {
                const postsWithImages = records.filter(
                  rec => rec.value.embed && rec.value.embed["$type"] === "app.bsky.embed.images"
                );
                const postsWithAltText = postsWithImages.filter(rec =>
                  rec.value.embed.images.some(img => img.alt && img.alt.trim())
                );
          
                return {
                  totalPosts: records.length,
                  postsWithImages: postsWithImages.length,
                  postsWithAltText: postsWithAltText.length,
                  altTextPercentage: (postsWithAltText.length / postsWithImages.length) * 100 || 0,
                };
              }
          
              document.getElementById("search-form").addEventListener("submit", async (event) => {
                event.preventDefault();
          
                const username = document.getElementById("username").value.trim();
                const resultsDiv = document.getElementById("results");
                resultsDiv.textContent = "Loading...";
          
                try {
                  const did = await resolveHandleToDID(username);
                  const records = await fetchRecordsForCollection(did, "app.bsky.feed.post");
                  const analysis = analyzePosts(records);
          
                  resultsDiv.innerHTML = `
                    <h2>Analysis Results for ${username}</h2>
                    <p>Total Posts: ${analysis.totalPosts}</p>
                    <p>Posts with Images: ${analysis.postsWithImages}</p>
                    <p>Posts with Alt Text: ${analysis.postsWithAltText}</p>
                    <p>Alt Text Usage: ${analysis.altTextPercentage.toFixed(2)}%</p>
                  `;
                } catch (error) {
                  resultsDiv.textContent = `Error: ${error.message}`;
                }
              });
            </script>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer"></div>

    <script src="js/main.js"></script>
</body>
</html>
